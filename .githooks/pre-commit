#!/bin/bash
# GCodeKit5 Pre-commit Hook
# Runs formatting, linting, and unit tests before commit
# Skip with: git commit --no-verify

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${YELLOW}Running pre-commit checks...${NC}"

# 1. Check formatting
echo -e "\n${YELLOW}[1/3] Checking code formatting...${NC}"
if ! cargo fmt --check 2>/dev/null; then
    echo -e "${RED}❌ Formatting check failed!${NC}"
    echo -e "Run 'cargo fmt' to fix formatting issues."
    exit 1
fi
echo -e "${GREEN}✓ Formatting OK${NC}"

# 2. Run clippy (warnings don't block, errors do)
echo -e "\n${YELLOW}[2/3] Running clippy lints...${NC}"
if ! cargo clippy --all --quiet -- -D warnings 2>/dev/null; then
    echo -e "${YELLOW}⚠ Clippy found issues (continuing anyway)${NC}"
    # Don't exit - clippy warnings shouldn't block commits
else
    echo -e "${GREEN}✓ Clippy OK${NC}"
fi

# 3. Run unit tests (lib only for speed)
echo -e "\n${YELLOW}[3/3] Running unit tests...${NC}"
if ! cargo test --lib --quiet 2>/dev/null; then
    echo -e "${RED}❌ Unit tests failed!${NC}"
    echo -e "Fix failing tests before committing."
    exit 1
fi
echo -e "${GREEN}✓ Tests OK${NC}"

echo -e "\n${GREEN}✓ All pre-commit checks passed!${NC}"
exit 0
